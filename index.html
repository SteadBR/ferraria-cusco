<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferraria Cusco - GestÃ£o Integrada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #f59e0b;
            --secondary: #3b82f6;
            --buy: #10b981;
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ffffff;
            --item-bg: #2a2a2a;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .nav-tabs { width: 100%; max-width: 1200px; display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.3s; color: white; opacity: 0.4; border: 1px solid rgba(255,255,255,0.1); }
        .tab-btn.active { opacity: 1; border: 1px solid white; }
        .btn-vendas { background: var(--primary); color: black; }
        .btn-producao { background: var(--secondary); }
        .btn-compras { background: var(--buy); }

        .shop-container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1fr 420px; gap: 20px; }
        
        header { 
            grid-column: 1 / -1; background: var(--card); padding: 15px; border-radius: 10px; 
            border-left: 5px solid var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 20px; 
        }
        .header-producao { border-left-color: var(--secondary) !important; }
        .header-compras { border-left-color: var(--buy) !important; }

        .logo-ferraria { width: 80px; height: 80px; object-fit: contain; }
        .header-text h1 { margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        .header-text small { color: var(--primary); font-weight: bold; text-transform: uppercase; }

        .filter-container { grid-column: 1 / -1; background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; align-items: center; gap: 15px; border: 1px solid #333; }
        .filter-container label { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: var(--buy); }
        .category-select { background: #121212; color: white; border: 1px solid var(--buy); padding: 10px; border-radius: 5px; outline: none; flex: 1; cursor: pointer; }

        .catalog { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .item-card { background: var(--item-bg); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #333; transition: 0.2s; }
        .product-img { width: 100px; height: 100px; object-fit: contain; margin-bottom: 10px; border-radius: 4px; }
        
        .buy-inputs { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px; }
        .input-row { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
        .input-row label { font-size: 0.65rem; font-weight: bold; color: #999; }

        .qty-input { width: 70px; background: #121212; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; text-align: center; font-size: 0.8rem; }
        .add-btn { border: none; padding: 8px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 8px; color: black; text-transform: uppercase; }

        .cart-panel { background: var(--card); padding: 25px; border-radius: 10px; border: 1px solid #333; height: fit-content; position: sticky; top: 20px; }
        .client-info { margin-bottom: 20px; display: flex; flex-direction: column; gap: 12px; }
        .client-info input, .display-data { text-transform: uppercase; background: #121212; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; }
        .display-data { display: none; border: none; border-bottom: 1px solid #444; font-weight: bold; padding: 5px 0; }

        .cart-items { list-style: none; padding: 0; margin: 15px 0; border-top: 1px solid #444; padding-top: 15px; }
        
        /* DivisÃ³ria de Categoria no Resumo */
        .cart-category-divider { background: rgba(16, 185, 129, 0.1); color: var(--buy); padding: 5px 10px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; border-left: 3px solid var(--buy); margin: 10px 0 5px 0; }

        .cart-item { border-bottom: 1px solid #333; padding: 12px 0; display: flex; flex-direction: column; gap: 8px; }
        .cart-item-header { display: flex; align-items: center; gap: 12px; font-size: 0.9rem; font-weight: bold; }
        .cart-item-img { width: 50px; height: 50px; object-fit: contain; background: transparent; border: none; }
        .cart-item-info { flex: 1; display: flex; justify-content: space-between; align-items: center; }

        .insumos-list { font-size: 0.8rem; color: #fbbf24; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; border-left: 3px solid var(--secondary); line-height: 1.6; }
        .insumo-line { display: block; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 2px 0; }
        
        .total-box { border-top: 2px solid var(--primary); padding-top: 15px; display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .checkout-btn { background: #059669; color: white; border: none; width: 100%; padding: 15px; border-radius: 5px; font-weight: bold; margin-top: 15px; cursor: pointer; text-transform: uppercase; }
        .clear-btn { background: transparent; color: #ef4444; border: 1px solid #ef4444; width: 100%; padding: 8px; border-radius: 5px; margin-top: 10px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="nav-tabs">
    <button class="tab-btn btn-vendas active" onclick="switchSystem('vendas')">Vendas</button>
    <button class="tab-btn btn-producao" onclick="switchSystem('producao')">CÃ¡lculo de ProduÃ§Ã£o</button>
    <button class="tab-btn btn-compras" onclick="switchSystem('compras')">Encomenda de Insumos</button>
</div>

<div class="shop-container">
    <header id="main-header">
        <img src="https://i.imgur.com/bQAy1gG.png" alt="Logo Cusco" class="logo-ferraria">
        <div class="header-text">
            <h1 id="title-text">FERRARIA CUSCO</h1>
            <small id="sub-text">REGISTRO DE PEDIDOS OFICIAL - 1905</small>
        </div>
    </header>

    <div class="filter-container" id="filter-bar">
        <label>Empresa:</label>
        <select id="category-select" class="category-select" onchange="renderCatalog()">
            <option value="TODOS">TODAS AS EMPRESAS</option>
            <option value="Fazendas">FAZENDAS</option>
            <option value="Mineradoras">MINERADORAS</option>
            <option value="Artesanatos">ARTESANATOS</option>
            <option value="Madeireiras">MADEIREIRAS</option>
        </select>
    </div>

    <div class="catalog" id="catalog"></div>

    <aside class="cart-panel" id="cart-capture">
        <h3 id="cart-title">ðŸ“‹ RESUMO</h3>
        
        <div class="client-info" id="info-contato">
            <div class="info-group"><label id="label-name">Nome do Cliente</label><input type="text" id="in-name" placeholder="NOME"><span id="out-name" class="display-data"></span></div>
            <div class="info-group" id="tele-group"><label>Telegrama</label><input type="text" id="in-tele" placeholder="USUÃRIO"><span id="out-tele" class="display-data"></span></div>
            <div class="info-group" id="disc-group"><label>Discord</label><input type="text" id="in-disc" placeholder="USUARIO#0000"><span id="out-disc" class="display-data"></span></div>
        </div>

        <div class="cart-items" id="cart-items"></div>

        <div class="total-box" id="total-border">
            <span id="total-label">TOTAL:</span>
            <span id="total-val-box">$<span id="total-val">0.00</span></span>
        </div>

        <div id="ui-buttons">
            <button id="main-action-btn" class="checkout-btn" onclick="generateImage()">SALVAR IMAGEM</button>
            <button class="clear-btn" onclick="clearCart()">LIMPAR TUDO</button>
        </div>
    </aside>
</div>

<script>
    let currentMode = 'vendas';
    let cart = {};

    const inventory = [
        { id: 1, name: "CÃ¡psula de MuniÃ§Ã£o", price: 0.86, img: "https://i.imgur.com/pYci4DW.png", recipe: { yield: 20, materials: [{n: "Lingote de Cobre", q: 3}, {n: "Verniz", q: 1}, {n: "CarvÃ£o Vegetal", q: 2}] } },
        { id: 2, name: "Cutelo", price: 3.12, img: "https://i.imgur.com/v4fRfq2.png", recipe: { yield: 1, materials: [{n: "TÃ¡bua de Madeira", q: 1}, {n: "Lingote de AÃ§o", q: 1}, {n: "Verniz", q: 1}] } },
        { id: 3, name: "Faca Comum", price: 7.80, img: "https://i.imgur.com/c7VZQFm.png", recipe: { yield: 7, materials: [{n: "Madeira CilÃ­ndrica", q: 4}, {n: "Lingote de AÃ§o", q: 3}] } },
        { id: 4, name: "Faca de Arremesso", price: 11.70, img: "https://i.imgur.com/tAnQ019.png", recipe: { yield: 1, materials: [{n: "TÃ¡bua de Madeira", q: 1}, {n: "Lingote de AÃ§o", q: 1}, {n: "Verniz", q: 1}] } },
        { id: 5, name: "Lingote de AÃ§o", price: 3.67, img: "https://i.imgur.com/k84v8UK.png", recipe: { yield: 3, materials: [{n: "Pepita de Prata", q: 4}, {n: "Pepita de Cobre", q: 5}, {n: "CarvÃ£o Vegetal", q: 5}] } },
        { id: 6, name: "Lingote de Cobre", price: 3.35, img: "https://i.imgur.com/3e9Rtrv.png", recipe: { yield: 2, materials: [{n: "Pepita de Cobre", q: 4}, {n: "CarvÃ£o", q: 6}] } },
        { id: 7, name: "Lingote de Ferro", price: 2.57, img: "https://i.imgur.com/FLBxUU9.png", recipe: { yield: 7, materials: [{n: "Pepita de Ferro", q: 9}, {n: "CarvÃ£o Bruto", q: 10}] } },
        { id: 8, name: "Lingote de Ouro", price: 3.98, img: "https://i.imgur.com/W09uKgt.png", recipe: { yield: 3, materials: [{n: "Pepita de Ouro", q: 7}, {n: "CarvÃ£o", q: 5}] } },
        { id: 9, name: "Lingote de Prata", price: 3.04, img: "https://i.imgur.com/OP2T9Xk.png", recipe: { yield: 2, materials: [{n: "Pepita de Prata", q: 5}, {n: "CarvÃ£o Vegetal", q: 1}] } },
        { id: 10, name: "Machado AvanÃ§ado", price: 11.70, img: "https://i.imgur.com/4O83Srs.png", recipe: { yield: 1, materials: [{n: "TÃ¡bua de Madeira", q: 1}, {n: "Pepita de Prata", q: 1}, {n: "Verniz", q: 1}] } },
        { id: 11, name: "Moedor", price: 0.59, img: "https://i.imgur.com/hJnt1RN.png", recipe: { yield: 10, materials: [{n: "Madeira CilÃ­ndrica", q: 1}, {n: "Pepita de Prata", q: 1}, {n: "Verniz", q: 1}, {n: "CarvÃ£o Vegetal", q: 1}] } },
        { id: 12, name: "Picareta AvanÃ§ada", price: 11.70, img: "https://i.imgur.com/MhMdBQL.png", recipe: { yield: 1, materials: [{n: "TÃ¡bua de Madeira", q: 1}, {n: "Pepita de Prata", q: 1}, {n: "Verniz", q: 1}, {n: "CarvÃ£o Vegetal", q: 1}] } },
        { id: 13, name: "Prego", price: 0.55, img: "https://i.imgur.com/KzcO0kY.png", recipe: { yield: 7, materials: [{n: "Pepita de Chumbo", q: 4}, {n: "CarvÃ£o Vegetal", q: 1}] } },
        { id: 14, name: "Rastelo", price: 2.34, img: "https://i.imgur.com/ptqDSbJ.png", recipe: { yield: 1, materials: [{n: "TÃ¡bua de Madeira", q: 3}, {n: "Lingote de AÃ§o", q: 1}] } },
        { id: 15, name: "Seringa de Vidro", price: 1.17, img: "https://i.imgur.com/YdoqXpy.png", recipe: { yield: 12, materials: [{n: "Garrafa de Ãlcool", q: 7}, {n: "Pepita de Quartzo", q: 10}] } }
    ];

    const supplyInventory = [
        { id: 101, category: "Fazendas", name: "Garrafa de Ãlcool", img: "https://i.imgur.com/VlBbvqI.png" },
        { id: 201, category: "Mineradoras", name: "CarvÃ£o Mineral Bruto", img: "https://i.imgur.com/PNhL30T.png" },
        { id: 202, category: "Mineradoras", name: "Pepita de Chumbo", img: "https://i.imgur.com/xb2QWoD.png" },
        { id: 203, category: "Mineradoras", name: "Pepita de Cobre", img: "https://i.imgur.com/G2gWC2r.png" },
        { id: 204, category: "Mineradoras", name: "Pepita de Ferro", img: "https://i.imgur.com/GDB3nyr.png" },
        { id: 205, category: "Mineradoras", name: "Pepita de Ouro", img: "https://i.imgur.com/lOiB6RO.png" },
        { id: 206, category: "Mineradoras", name: "Pepita de Prata", img: "https://i.imgur.com/au2hezv.png" },
        { id: 207, category: "Mineradoras", name: "Pepita de Quartzo", img: "https://i.imgur.com/D7w2HiZ.png" },
        { id: 301, category: "Artesanatos", name: "Verniz", img: "https://i.imgur.com/61jHucx.png" },
        { id: 401, category: "Madeireiras", name: "CarvÃ£o Vegetal", img: "https://i.imgur.com/PNhL30T.png" },
        { id: 402, category: "Madeireiras", name: "Madeira CilÃ­ndrica", img: "https://i.imgur.com/H0Xwc7K.png" },
        { id: 403, category: "Madeireiras", name: "TÃ¡bua de Madeira", img: "https://i.imgur.com/dxg6GMd.png" }
    ];

    function switchSystem(mode) {
        currentMode = mode;
        clearCart();
        const isBuy = mode === 'compras';
        const isProd = mode === 'producao';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.btn-${mode}`).classList.add('active');
        
        const header = document.getElementById('main-header');
        header.className = '';
        if(isProd) header.classList.add('header-producao');
        if(isBuy) header.classList.add('header-compras');

        document.getElementById('filter-bar').style.display = isBuy ? "flex" : "none";
        document.getElementById('info-contato').style.display = (isProd || isBuy) ? "none" : "flex";
        
        document.getElementById('cart-title').innerText = isBuy ? "ðŸ›’ LISTA DE ENCOMENDA" : (isProd ? "ðŸ“¦ MATERIAIS PARA PRODUÃ‡ÃƒO" : "ðŸ“‹ RESUMO DO PEDIDO");
        document.getElementById('total-label').innerText = "TOTAL:";
        document.getElementById('total-val-box').style.display = isProd ? "none" : "block";
        
        const borderColor = isBuy ? "var(--buy)" : (isProd ? "var(--secondary)" : "var(--primary)");
        document.getElementById('total-border').style.borderTopColor = borderColor;
        document.getElementById('total-border').style.color = borderColor;
        
        renderCatalog();
    }

    function renderCatalog() {
        const grid = document.getElementById('catalog');
        const accent = currentMode === 'compras' ? 'var(--buy)' : (currentMode === 'producao' ? 'var(--secondary)' : 'var(--primary)');
        let displayList = currentMode === 'compras' ? supplyInventory : inventory;

        if (currentMode === 'compras') {
            const selectedCat = document.getElementById('category-select').value;
            if (selectedCat !== "TODOS") displayList = displayList.filter(i => i.category === selectedCat);
        }

        grid.innerHTML = displayList.map(item => {
            const inputs = currentMode === 'compras' ? `
                <div class="buy-inputs">
                    <div class="input-row"><label>QTD:</label><input type="number" id="qty-${item.id}" class="qty-input" value="1" min="1"></div>
                    <div class="input-row"><label>UNIT:</label><input type="number" id="price-${item.id}" class="qty-input" value="0.00" step="0.01"></div>
                </div>` : `<div style="display:flex; gap:5px; justify-content:center; align-items:center; margin-top:10px;"><span style="font-size:0.7rem">QTD:</span><input type="number" id="qty-${item.id}" class="qty-input" value="1" min="1"></div>`;

            return `<div class="item-card" style="border-color: ${currentMode === 'vendas' ? '#333' : accent}"><img src="${item.img}" class="product-img"><h4 style="font-size: 0.8rem; margin: 5px 0;">${item.name.toUpperCase()}</h4>${currentMode === 'vendas' ? `<span class="item-price">$${item.price.toFixed(2)}</span>` : ''}${(currentMode === 'producao' && item.recipe) ? `<div class="recipe-info">1 Lote = ${item.recipe.yield} un.</div>` : ''}${inputs}<button class="add-btn" style="background-color: ${accent}" onclick="addToCart(${item.id})">ADD</button></div>`;
        }).join('');
    }

    function addToCart(id) {
        const inv = currentMode === 'compras' ? supplyInventory : inventory;
        const prod = inv.find(i => i.id === id);
        const qtyVal = parseInt(document.getElementById(`qty-${id}`).value);
        if (qtyVal <= 0 || isNaN(qtyVal)) return;

        let finalPrice = prod.price || 0;
        if(currentMode === 'compras') finalPrice = parseFloat(document.getElementById(`price-${id}`).value) || 0;

        if (cart[id]) {
            cart[id].quantity += qtyVal;
            if(currentMode === 'compras') cart[id].price = finalPrice;
        } else {
            cart[id] = { ...prod, quantity: qtyVal, price: finalPrice };
        }
        updateUI();
    }

    function removeItem(id) { delete cart[id]; updateUI(); }
    function clearCart() { cart = {}; updateUI(); }

    function updateUI() {
        const cartList = document.getElementById('cart-items');
        let total = 0;
        let lastCategory = "";
        let htmlContent = "";

        const items = Object.values(cart);

        if (currentMode === 'compras') {
            // Ordena por categoria para agrupar no resumo
            items.sort((a, b) => a.category.localeCompare(b.category));
        }

        items.forEach(item => {
            if (currentMode === 'compras' && item.category !== lastCategory) {
                lastCategory = item.category;
                htmlContent += `<div class="cart-category-divider">${lastCategory}</div>`;
            }

            let infoHTML = "";
            let priceColHTML = "";

            if(currentMode === 'producao' && item.recipe) {
                const numLotes = Math.ceil(item.quantity / item.recipe.yield);
                infoHTML = `<div class="insumos-list"><b>LOTES:</b> ${numLotes} | <b>TOTAL:</b> ${numLotes * item.recipe.yield} UN.<br><div style="margin-top:5px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;">${item.recipe.materials.map(m => `<span class="insumo-line">â€¢ ${m.q * numLotes}x ${m.n.toUpperCase()}</span>`).join('')}</div></div>`;
            } else {
                const subTotal = item.price * item.quantity;
                total += subTotal;
                priceColHTML = `<span>$${subTotal.toFixed(2)}</span>`;
            }

            htmlContent += `<div class="cart-item"><div class="cart-item-header"><img src="${item.img}" class="cart-item-img"><div class="cart-item-info"><span>${item.name.toUpperCase()} (x${item.quantity})</span>${priceColHTML}<button onclick="removeItem(${item.id})" style="color:#ef4444; border:none; background:none; cursor:pointer; font-weight:bold;">âœ•</button></div></div>${infoHTML}</div>`;
        });

        cartList.innerHTML = htmlContent;
        document.getElementById('total-val').innerText = total.toFixed(2);
    }

    async function generateImage() {
        if(Object.keys(cart).length === 0) return alert("A lista estÃ¡ vazia!");
        if(currentMode === 'vendas') {
            const n = document.getElementById('in-name').value;
            if(!n || !document.getElementById('in-disc').value || !document.getElementById('in-tele').value) return alert("Preencha todos os campos!");
            document.getElementById('out-name').innerText = n.toUpperCase();
            document.getElementById('out-disc').innerText = document.getElementById('in-disc').value.toUpperCase();
            document.getElementById('out-tele').innerText = document.getElementById('in-tele').value.toUpperCase();
            document.querySelectorAll('#info-contato input').forEach(i => i.style.display = 'none');
            document.querySelectorAll('.display-data').forEach(s => s.style.display = 'block');
        }
        document.getElementById('ui-buttons').style.display = 'none';
        document.querySelectorAll('.cart-item button').forEach(b => b.style.display = 'none');
        const canvas = await html2canvas(document.getElementById('cart-capture'), { backgroundColor: "#1e1e1e", scale: 2, useCORS: true });
        const link = document.createElement('a');
        link.download = `${currentMode.toUpperCase()}_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL(); link.click();
        document.getElementById('ui-buttons').style.display = 'block';
        document.querySelectorAll('.cart-item button').forEach(b => b.style.display = 'inline');
        if(currentMode === 'vendas') {
            document.querySelectorAll('#info-contato input').forEach(i => i.style.display = 'block');
            document.querySelectorAll('.display-data').forEach(s => s.style.display = 'none');
        }
    }
    switchSystem('vendas');
</script>
</body>
</html>